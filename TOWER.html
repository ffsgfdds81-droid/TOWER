<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–•—Ä–æ–Ω–∏–∫–∏ –ë–∞—Å—Ç–∏–æ–Ω–∞: –í–æ–π–Ω–∞ –ó–∞ –†—É–±–µ–∂–∏</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0a1931 0%, #185adb 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        /* –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é */
        .menu-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a1931 0%, #185adb 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }
        
        .menu-screen.hidden {
            display: none;
        }
        
        .menu-title {
            font-size: 4rem;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.7);
            margin-bottom: 40px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 300px;
        }
        
        .menu-btn {
            padding: 20px 40px;
            font-size: 1.5rem;
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            border: none;
            border-radius: 15px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .menu-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            background: linear-gradient(45deg, #ff4b2b, #ff416c);
        }
        
        /* –≠–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —É—Ä–æ–≤–Ω—è */
        .level-select-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a1931 0%, #185adb 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 900;
            padding: 40px;
        }
        
        .level-select-screen.hidden {
            display: none;
        }
        
        .level-title {
            font-size: 3rem;
            color: #ffd700;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .levels-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            max-width: 1000px;
            margin: 20px 0;
        }
        
        .level-btn {
            width: 120px;
            height: 120px;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(45deg, #00b4db, #0083b0);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .level-btn.completed {
            background: linear-gradient(45deg, #00b09b, #96c93d);
        }
        
        .level-btn.locked {
            background: linear-gradient(45deg, #8e9eab, #eef2f3);
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .level-btn:hover:not(.locked) {
            transform: scale(1.1);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        .level-name {
            font-size: 1rem;
            margin-top: 10px;
        }
        
        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid white;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(-5px);
        }
        
        /* –ò–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω */
        .game-screen {
            width: 100%;
            height: 100%;
            display: none;
        }
        
        .game-screen.active {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .game-header {
            width: 1200px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 0 0 20px 20px;
            margin-bottom: 20px;
        }
        
        .game-stats {
            display: flex;
            gap: 30px;
        }
        
        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-value {
            font-size: 1.8rem;
            color: #ffd700;
            font-weight: bold;
        }
        
        .game-controls {
            display: flex;
            gap: 15px;
        }
        
        .game-btn {
            padding: 12px 24px;
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .game-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .game-container {
            display: flex;
            gap: 30px;
        }
        
        .game-board {
            width: 800px;
            height: 600px;
            background: #0a1931;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        
        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        .tower-panel {
            width: 300px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .tower-list {
            display: grid;
            /* 60 –±–∞—à–µ–Ω - 4 –∫–æ–ª–æ–Ω–∫–∏ */
            grid-template-columns: repeat(4, 1fr); 
            gap: 10px;
            margin-top: 20px;
        }
        
        .tower-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            /* –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä, —á—Ç–æ–±—ã –≤–º–µ—Å—Ç–∏—Ç—å –±–æ–ª—å—à–µ */
            height: 80px; 
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .tower-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-3px);
        }
        
        .tower-item.selected {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
        }
        
        .tower-icon {
            font-size: 1.5rem;
            margin-bottom: 3px;
        }
        
        .tower-name {
            font-size: 0.7rem;
            line-height: 1;
            margin-bottom: 2px;
        }
        
        .tower-cost {
            font-size: 0.8rem;
            color: #ffd700;
            font-weight: bold;
        }
        
        /* –≠–∫—Ä–∞–Ω –ø–æ–±–µ–¥—ã (–í—ã–∏–≥—Ä—ã—à) */
        .victory-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 800;
        }
        
        .victory-screen.active {
            display: flex;
        }
        
        .victory-title {
            /* –û–ë–ù–û–í–õ–ï–ù–û: –ù–∞–∑–≤–∞–Ω–∏–µ –º–µ–Ω—é –í—ã–∏–≥—Ä—ã—à–∞ */
            font-size: 5rem;
            color: #ffd700;
            margin-bottom: 30px;
            animation: victoryGlow 1.5s infinite alternate;
        }
        
        @keyframes victoryGlow {
            from { text-shadow: 0 0 20px #ffd700; }
            to { text-shadow: 0 0 40px #ffd700, 0 0 60px #ffd700; }
        }
        
        .victory-stats {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            min-width: 400px;
        }
        
        .victory-stat {
            text-align: center;
        }
        
        .victory-stat-value {
            font-size: 2rem;
            color: #ffd700;
            font-weight: bold;
        }
        
        /* –≠–∫—Ä–∞–Ω –ø–æ—Ä–∞–∂–µ–Ω–∏—è (–ü—Ä–æ–∏–≥—Ä—ã—à) */
        .defeat-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 800;
        }
        
        .defeat-screen.active {
            display: flex;
        }
        
        .defeat-title {
            /* –û–ë–ù–û–í–õ–ï–ù–û: –ù–∞–∑–≤–∞–Ω–∏–µ –º–µ–Ω—é –ü–æ—Ä–∞–∂–µ–Ω–∏—è */
            font-size: 5rem;
            color: #ff416c;
            margin-bottom: 30px;
            animation: defeatGlow 1.5s infinite alternate;
        }
        
        @keyframes defeatGlow {
            from { text-shadow: 0 0 20px #ff416c; }
            to { text-shadow: 0 0 40px #ff416c, 0 0 60px #ff416c; }
        }
        
        /* –í–æ–ª–Ω–æ–≤–æ–π —ç–∫—Ä–∞–Ω */
        .wave-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 700;
        }
        
        .wave-screen.active {
            display: flex;
        }
        
        .wave-title {
            font-size: 4rem;
            color: #00b4db;
            margin-bottom: 20px;
            animation: wavePulse 1s infinite;
        }
        
        @keyframes wavePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .wave-enemies {
            font-size: 1.5rem;
            color: #ffd700;
            margin-bottom: 30px;
        }
        
        /* –ü–∞—É–∑–∞ */
        .pause-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 700;
        }
        
        .pause-screen.active {
            display: flex;
        }
        
        .pause-title {
            font-size: 4rem;
            color: #ffd700;
            margin-bottom: 40px;
        }
        
        .level-progress {
            margin: 20px 0;
            color: #ffd700;
            font-size: 1.2rem;
        }
    </style>
</head>
<body>
    <div class="menu-screen" id="menuScreen">
        <div class="menu-title">–•–†–û–ù–ò–ö–ò –ë–ê–°–¢–ò–û–ù–ê</div>
        <div class="menu-buttons">
            <button class="menu-btn" id="playBtn">–ò–ì–†–ê–¢–¨</button>
            <button class="menu-btn" id="continueBtn">–ü–†–û–î–û–õ–ñ–ò–¢–¨</button>
            <button class="menu-btn" id="helpBtn">–ü–†–ê–í–ò–õ–ê</button>
        </div>
    </div>
    
    <div class="level-select-screen hidden" id="levelSelectScreen">
        <button class="back-btn" id="backToMenuBtn">‚Üê –ù–∞–∑–∞–¥</button>
        <div class="level-title">–í–´–ë–ï–†–ò–¢–ï –£–†–û–í–ï–ù–¨</div>
        <div class="levels-grid" id="levelsGrid">
            </div>
    </div>
    
    <div class="game-screen" id="gameScreen">
        <div class="game-header">
            <div class="game-stats">
                <div class="stat">
                    <div>–£–†–û–í–ï–ù–¨</div>
                    <div id="currentLevel" class="stat-value">1</div>
                </div>
                <div class="stat">
                    <div>–í–û–õ–ù–ê</div>
                    <div id="currentWave" class="stat-value">1/20</div>
                </div>
                <div class="stat">
                    <div>–ó–î–û–†–û–í–¨–ï</div>
                    <div id="health" class="stat-value">100</div>
                </div>
                <div class="stat">
                    <div>–ó–û–õ–û–¢–û</div>
                    <div id="money" class="stat-value">500</div>
                </div>
                <div class="stat">
                    <div>–°–ß–Å–¢</div>
                    <div id="score" class="stat-value">0</div>
                </div>
            </div>
            <div class="game-controls">
                <button class="game-btn" id="pauseBtn">‚è∏ –ü–ê–£–ó–ê</button>
                <button class="game-btn" id="menuBtn">üè† –ú–ï–ù–Æ</button>
            </div>
        </div>
        
        <div class="game-container">
            <div class="game-board">
                <canvas id="gameCanvas" width="800" height="600"></canvas>
                
                <div class="wave-screen" id="waveScreen">
                    <div class="wave-title" id="waveTitle">–í–û–õ–ù–ê 1</div>
                    <div class="wave-enemies" id="waveEnemies">–ì–æ—Ç–æ–≤—å—Ç–µ—Å—å –∫ –∞—Ç–∞–∫–µ!</div>
                    <button class="menu-btn" id="startWaveBtn">–ù–ê–ß–ê–¢–¨ –í–û–õ–ù–£</button>
                </div>
                
                <div class="pause-screen" id="pauseScreen">
                    <div class="pause-title">–ü–ê–£–ó–ê</div>
                    <div class="level-progress" id="levelProgress">–£—Ä–æ–≤–µ–Ω—å 1 ‚Ä¢ –í–æ–ª–Ω–∞ 1/20</div>
                    <div class="menu-buttons">
                        <button class="menu-btn" id="resumeBtn">–ü–†–û–î–û–õ–ñ–ò–¢–¨</button>
                        <button class="menu-btn" id="restartLevelBtn">–ó–ê–ù–û–í–û</button>
                        <button class="menu-btn" id="toMenuFromPauseBtn">–í –ú–ï–ù–Æ</button>
                    </div>
                </div>
            </div>
            
            <div class="tower-panel">
                <h3 style="color: #ffd700; text-align: center; margin-bottom: 20px;">–í–´–ë–û–† –ë–ê–®–ù–ò (60 –≤–∏–¥–æ–≤)</h3>
                <div class="tower-list" id="towerList">
                    </div>
                <div style="margin-top: 30px;">
                    <button class="game-btn" id="upgradeBtn" style="width: 100%; margin-bottom: 10px;">‚¨Ü –£–õ–£–ß–®–ò–¢–¨ (100üí∞)</button>
                    <button class="game-btn" id="sellBtn" style="width: 100%; background: linear-gradient(45deg, #8e44ad, #9b59b6);">üí∞ –ü–†–û–î–ê–¢–¨ (50%)</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="victory-screen" id="victoryScreen">
        <div class="victory-title">–ü–û–ë–ï–î–ê!</div>
        <div class="victory-stats">
            <div class="victory-stat">
                <div>–£—Ä–æ–≤–µ–Ω—å</div>
                <div id="victoryLevel" class="victory-stat-value">1</div>
            </div>
            <div class="victory-stat">
                <div>–í–æ–ª–Ω –ø—Ä–æ–π–¥–µ–Ω–æ</div>
                <div id="victoryWaves" class="victory-stat-value">20/20</div>
            </div>
            <div class="victory-stat">
                <div>–í—Ä–∞–≥–æ–≤ —É–±–∏—Ç–æ</div>
                <div id="victoryKills" class="victory-stat-value">0</div>
            </div>
            <div class="victory-stat">
                <div>–ó–æ–ª–æ—Ç–∞ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
                <div id="victoryGold" class="victory-stat-value">0</div>
            </div>
        </div>
        <div class="menu-buttons">
            <button class="menu-btn" id="nextLevelBtn">–°–õ–ï–î–£–Æ–©–ò–ô –£–†–û–í–ï–ù–¨</button>
            <button class="menu-btn" id="toMenuFromVictoryBtn">–í –ú–ï–ù–Æ</button>
        </div>
    </div>
    
    <div class="defeat-screen" id="defeatScreen">
        <div class="defeat-title">–ü–û–†–ê–ñ–ï–ù–ò–ï</div>
        <div class="victory-stats">
            <div class="victory-stat">
                <div>–£—Ä–æ–≤–µ–Ω—å</div>
                <div id="defeatLevel" class="victory-stat-value">1</div>
            </div>
            <div class="victory-stat">
                <div>–í–æ–ª–Ω –ø—Ä–æ–π–¥–µ–Ω–æ</div>
                <div id="defeatWaves" class="victory-stat-value">0/20</div>
            </div>
            <div class="victory-stat">
                <div>–í—Ä–∞–≥–æ–≤ —É–±–∏—Ç–æ</div>
                <div id="defeatKills" class="victory-stat-value">0</div>
            </div>
            <div class="victory-stat">
                <div>–°—á—ë—Ç</div>
                <div id="defeatScore" class="victory-stat-value">0</div>
            </div>
        </div>
        <div class="menu-buttons">
            <button class="menu-btn" id="restartFromDefeatBtn">–ü–û–ü–†–û–ë–û–í–ê–¢–¨ –°–ù–û–í–ê</button>
            <button class="menu-btn" id="toMenuFromDefeatBtn">–í –ú–ï–ù–Æ</button>
        </div>
    </div>

    <script>
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM (–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –∫—Ä–æ–º–µ –Ω–æ–≤–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞)
        const menuScreen = document.getElementById('menuScreen');
        const levelSelectScreen = document.getElementById('levelSelectScreen');
        const gameScreen = document.getElementById('gameScreen');
        const victoryScreen = document.getElementById('victoryScreen');
        const defeatScreen = document.getElementById('defeatScreen');
        const waveScreen = document.getElementById('waveScreen');
        const pauseScreen = document.getElementById('pauseScreen');
        
        const playBtn = document.getElementById('playBtn');
        const continueBtn = document.getElementById('continueBtn');
        const backToMenuBtn = document.getElementById('backToMenuBtn');
        const levelsGrid = document.getElementById('levelsGrid');
        const towerList = document.getElementById('towerList');
        
        // –ò–≥—Ä–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let game = {
            currentLevel: 1,
            currentWave: 0,
            maxWaves: 20, // 20 –í–û–õ–ù
            health: 100,
            money: 500,
            score: 0,
            kills: 0,
            selectedTower: 'archer',
            towers: [],
            enemies: [],
            projectiles: [],
            effects: [],
            path: [],
            selectedTowerIndex: -1,
            waveInProgress: false,
            enemyCount: 0,
            maxEnemies: 0,
            gameRunning: false,
            gamePaused: false,
            completedLevels: JSON.parse(localStorage.getItem('tdCompletedLevels')) || [],
            waveStartTime: 0
        };
        
        // –£—Ä–æ–≤–Ω–∏ (20 —É—Ä–æ–≤–Ω–µ–π)
        const levels = [
            { name: "–ù–∞—á–∞–ª–æ –ø—É—Ç–∏", enemyHealth: 100, enemySpeed: 1, money: 500, health: 100 },
            { name: "–õ–µ—Å–Ω–∞—è —Ç—Ä–æ–ø–∞", enemyHealth: 120, enemySpeed: 1.1, money: 550, health: 100 },
            { name: "–ì–æ—Ä–Ω—ã–π –ø–µ—Ä–µ–≤–∞–ª", enemyHealth: 140, enemySpeed: 1.2, money: 600, health: 100 },
            { name: "–ü—É—Å—Ç—ã–Ω—è", enemyHealth: 160, enemySpeed: 1.1, money: 650, health: 100 },
            { name: "–ë–æ–ª–æ—Ç–∞", enemyHealth: 180, enemySpeed: 0.9, money: 700, health: 100 },
            { name: "–õ–µ–¥—è–Ω—ã–µ –ø–µ—â–µ—Ä—ã", enemyHealth: 200, enemySpeed: 1.3, money: 750, health: 100 },
            { name: "–í—É–ª–∫–∞–Ω", enemyHealth: 220, enemySpeed: 1.2, money: 800, health: 100 },
            { name: "–ü–æ–¥–∑–µ–º–µ–ª—å–µ", enemyHealth: 240, enemySpeed: 1.1, money: 850, health: 100 },
            { name: "–•—Ä–∞–º", enemyHealth: 260, enemySpeed: 1.2, money: 900, health: 100 },
            { name: "–ö—Ä–µ–ø–æ—Å—Ç—å", enemyHealth: 300, enemySpeed: 1, money: 1000, health: 100 },
            { name: "–ù–µ–±–µ—Å–Ω—ã–π –ø—É—Ç—å", enemyHealth: 320, enemySpeed: 1.4, money: 1100, health: 100 },
            { name: "–û–∫–µ–∞–Ω—Å–∫–∏–µ –≥–ª—É–±–∏–Ω—ã", enemyHealth: 340, enemySpeed: 0.8, money: 1200, health: 100 },
            { name: "–ö–æ—Å–º–∏—á–µ—Å–∫–∞—è —Å—Ç–∞–Ω—Ü–∏—è", enemyHealth: 360, enemySpeed: 1.3, money: 1300, health: 100 },
            { name: "–ò–∑–º–µ—Ä–µ–Ω–∏–µ —Ö–∞–æ—Å–∞", enemyHealth: 380, enemySpeed: 1.5, money: 1400, health: 100 },
            { name: "–¶–∏—Ç–∞–¥–µ–ª—å —Ç—å–º—ã", enemyHealth: 400, enemySpeed: 1.2, money: 1500, health: 100 },
            { name: "–õ–∞–±–∏—Ä–∏–Ω—Ç", enemyHealth: 450, enemySpeed: 1.1, money: 1600, health: 100 },
            { name: "–ê—Ä–µ–Ω–∞", enemyHealth: 500, enemySpeed: 1.3, money: 1700, health: 100 },
            { name: "–¢—Ä–æ–Ω–Ω—ã–π –∑–∞–ª", enemyHealth: 550, enemySpeed: 1.2, money: 1800, health: 100 },
            { name: "–í—Ä–∞—Ç–∞ –∞–¥–∞", enemyHealth: 600, enemySpeed: 1.4, money: 1900, health: 100 },
            { name: "–§–∏–Ω–∞–ª—å–Ω–æ–µ –∏—Å–ø—ã—Ç–∞–Ω–∏–µ", enemyHealth: 700, enemySpeed: 1.5, money: 2000, health: 100 }
        ];
        
        // –¢–∏–ø—ã –±–∞—à–µ–Ω (60 –≤–∏–¥–æ–≤)
        const towerTypes = {
            archer: { name: '–õ—É—á–Ω–∏–∫', cost: 100, damage: 20, range: 150, speed: 800, color: '#4CAF50', icon: 'üèπ' },
            cannon: { name: '–ü—É—à–∫–∞', cost: 150, damage: 40, range: 120, speed: 1500, color: '#FF5722', icon: 'üí£' },
            mage: { name: '–ú–∞–≥', cost: 200, damage: 30, range: 140, speed: 1000, color: '#9C27B0', icon: 'üîÆ' },
            ice: { name: '–õ–µ–¥—è–Ω–∞—è', cost: 180, damage: 15, range: 130, speed: 900, color: '#03A9F4', icon: '‚ùÑÔ∏è' },
            laser: { name: '–õ–∞–∑–µ—Ä', cost: 250, damage: 10, range: 180, speed: 100, color: '#F44336', icon: 'üî¶' },
            poison: { name: '–Ø–¥', cost: 220, damage: 25, range: 140, speed: 1200, color: '#4CAF50', icon: '‚ò£Ô∏è' },
            tesla: { name: '–¢–µ—Å–ª–∞', cost: 300, damage: 15, range: 160, speed: 800, color: '#FFEB3B', icon: '‚ö°' },
            sonic: { name: '–°–æ–Ω–∏–∫', cost: 350, damage: 35, range: 100, speed: 500, color: '#2196F3', icon: 'üåÄ' },
            mario: { name: '–ú–∞—Ä–∏–æ', cost: 320, damage: 40, range: 90, speed: 2000, color: '#E91E63', icon: 'üë®‚Äçüîß' },
            ninja: { name: '–ù–∏–Ω–¥–∑—è', cost: 280, damage: 30, range: 80, speed: 400, color: '#000000', icon: 'ü•∑' },
            dragon: { name: '–î—Ä–∞–∫–æ–Ω', cost: 500, damage: 50, range: 170, speed: 2000, color: '#FF9800', icon: 'üêâ' },
            golem: { name: '–ì–æ–ª–µ–º', cost: 400, damage: 60, range: 110, speed: 2500, color: '#795548', icon: 'üóø' },
            necromancer: { name: '–ù–µ–∫—Ä–æ–º–∞–Ω—Ç', cost: 450, damage: 20, range: 150, speed: 3000, color: '#009688', icon: '‚ò†Ô∏è' },
            catapult: { name: '–ö–∞—Ç–∞–ø—É–ª—å—Ç–∞', cost: 380, damage: 45, range: 200, speed: 3000, color: '#8D6E63', icon: 'ü™®' },
            sniper: { name: '–°–Ω–∞–π–ø–µ—Ä', cost: 270, damage: 70, range: 250, speed: 2000, color: '#607D8B', icon: 'üéØ' },
            storm: { name: '–®—Ç–æ—Ä–º', cost: 330, damage: 25, range: 160, speed: 1800, color: '#3F51B5', icon: 'üå©Ô∏è' },
            vampire: { name: '–í–∞–º–ø–∏—Ä', cost: 290, damage: 35, range: 130, speed: 1400, color: '#D32F2F', icon: 'ü¶á' },
            portal: { name: '–ü–æ—Ä—Ç–∞–ª', cost: 420, damage: 0, range: 120, speed: 3000, color: '#7B1FA2', icon: 'üåÄ' },
            time: { name: '–í—Ä–µ–º—è', cost: 360, damage: 10, range: 150, speed: 2000, color: '#00BCD4', icon: '‚è±Ô∏è' },
            earthquake: { name: '–ó–µ–º–ª—è', cost: 480, damage: 60, range: 100, speed: 4000, color: '#8BC34A', icon: 'üåã' },
            spearman: { name: '–ö–æ–ø—å–µ–Ω–æ—Å–µ—Ü', cost: 110, damage: 15, range: 100, speed: 500, color: '#B7950B', icon: 'üî±' },
            flamethrower: { name: '–û–≥–Ω–µ–º–µ—Ç', cost: 240, damage: 5, range: 100, speed: 50, color: '#FF4500', icon: 'üî•' },
            shrapnel: { name: '–®—Ä–∞–ø–Ω–µ–ª—å', cost: 170, damage: 30, range: 160, speed: 2000, color: '#6C7A89', icon: 'üí•' },
            magnetic: { name: '–ú–∞–≥–Ω–∏—Ç', cost: 260, damage: 0, range: 180, speed: 1500, color: '#34495E', icon: 'üß≤' },
            alchemy: { name: '–ê–ª—Ö–∏–º–∏—è', cost: 310, damage: 20, range: 140, speed: 1100, color: '#F39C12', icon: 'üß™' },
            barricade: { name: '–ë–∞—Ä—Ä–∏–∫–∞–¥–∞', cost: 50, damage: 0, range: 0, speed: 0, color: '#A0522D', icon: 'üöß' },
            oracle: { name: '–û—Ä–∞–∫—É–ª', cost: 390, damage: 0, range: 300, speed: 5000, color: '#4B0082', icon: 'üëÅÔ∏è' },
            minigun: { name: '–ú–∏–Ω–∏–≥–∞–Ω', cost: 280, damage: 8, range: 120, speed: 80, color: '#696969', icon: 'üî´' },
            cryo: { name: '–ö—Ä–∏–æ-–ø—É—à–∫–∞', cost: 230, damage: 15, range: 150, speed: 1300, color: '#00FFFF', icon: 'ü•∂' },
            bounty: { name: '–û—Ö–æ—Ç–Ω–∏–∫', cost: 350, damage: 20, range: 170, speed: 1800, color: '#FFD700', icon: 'üí∞' },
            teleporter: { name: '–¢–µ–ª–µ–ø–æ—Ä—Ç', cost: 430, damage: 0, range: 100, speed: 5000, color: '#8A2BE2', icon: 'üåå' },
            poisonGas: { name: '–Ø–¥–æ–≤–∏—Ç—ã–π –ì–∞–∑', cost: 200, damage: 1, range: 110, speed: 50, color: '#90EE90', icon: 'üí®' },
            stoneThrower: { name: '–ö–∞–º–µ–Ω—â–∏–∫', cost: 130, damage: 50, range: 180, speed: 4000, color: '#A9A9A9', icon: 'ü™®' },
            spirit: { name: '–î—É—Ö', cost: 370, damage: 30, range: 140, speed: 1600, color: '#00FA9A', icon: 'üëª' },
            blackHole: { name: '–ß–µ—Ä–Ω–∞—è –î—ã—Ä–∞', cost: 550, damage: 100, range: 100, speed: 6000, color: '#000000', icon: '‚ö´' },
            artillery: { name: '–ê—Ä—Ç–∏–ª–ª–µ—Ä–∏—è', cost: 410, damage: 80, range: 400, speed: 3500, color: '#B8860B', icon: 'ü§Ø' },
            reflect: { name: '–û—Ç—Ä–∞–∂–∞—Ç–µ–ª—å', cost: 300, damage: 0, range: 130, speed: 1000, color: '#7FFFD4', icon: 'üõ°Ô∏è' },
            swarm: { name: '–†–æ–π', cost: 270, damage: 10, range: 110, speed: 100, color: '#556B2F', icon: 'üêù' },
            gravity: { name: '–ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è', cost: 460, damage: 5, range: 160, speed: 2000, color: '#4682B4', icon: '‚¨áÔ∏è' },
            steam: { name: '–ü–∞—Ä', cost: 190, damage: 20, range: 100, speed: 1000, color: '#DCDCDC', icon: '‚öôÔ∏è' },
            // –ù–æ–≤—ã–µ 20 –±–∞—à–µ–Ω (41-60)
            convert: { name: '–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä', cost: 500, damage: 0, range: 100, speed: 8000, color: '#FF69B4', icon: 'üíñ' },
            bomb: { name: '–ë–æ–º–±–∞—Ä–¥–∏—Ä', cost: 350, damage: 90, range: 150, speed: 4500, color: '#556B2F', icon: 'üí•' },
            percent: { name: '–ü—Ä–æ—Ü–µ–Ω—Ç', cost: 420, damage: 5, range: 180, speed: 2000, color: '#00FF7F', icon: 'üìà' },
            freezer: { name: '–ì–ª—É–±–æ–∫–∞—è –ó–∞–º–æ—Ä–æ–∑–∫–∞', cost: 380, damage: 5, range: 140, speed: 5000, color: '#1E90FF', icon: 'üßä' },
            execute: { name: '–ü–∞–ª–∞—á', cost: 450, damage: 30, range: 160, speed: 1500, color: '#8B0000', icon: 'üó°Ô∏è' },
            slowField: { name: '–ü–æ–ª–µ –ó–∞–º–µ–¥–ª–µ–Ω–∏—è', cost: 210, damage: 0, range: 120, speed: 100, color: '#4682B4', icon: 'üêå' },
            pierce: { name: '–ü—Ä–æ–±–æ–π–Ω–∏–∫', cost: 300, damage: 35, range: 200, speed: 2000, color: '#9ACD32', icon: ' xuy√™n' },
            chain: { name: '–¶–µ–ø–Ω–∞—è –†–µ–∞–∫—Ü–∏—è', cost: 320, damage: 25, range: 170, speed: 1100, color: '#FFD700', icon: 'üîó' },
            buff: { name: '–ë–∞—Ñ—Ñ–µ—Ä', cost: 400, damage: 0, range: 100, speed: 5000, color: '#FF1493', icon: '‚ú®' },
            acid: { name: '–ö–∏—Å–ª–æ—Ç–Ω—ã–π –î–æ–∂–¥—å', cost: 390, damage: 10, range: 150, speed: 1500, color: '#7CFC00', icon: 'üíß' },
            chrono: { name: '–•—Ä–æ–Ω–æ—Å', cost: 520, damage: 1, range: 150, speed: 100, color: '#4B0082', icon: 'üï∞Ô∏è' },
            random: { name: '–†–∞–Ω–¥–æ–º', cost: 440, damage: 10, range: 140, speed: 1200, color: '#808080', icon: 'üé≤' },
            farShot: { name: '–î–∞–ª—å–Ω–æ–±–æ–π—â–∏–∫', cost: 280, damage: 10, range: 300, speed: 800, color: '#483D8B', icon: 'üî≠' },
            shockwave: { name: '–£–¥–∞—Ä–Ω–∞—è –í–æ–ª–Ω–∞', cost: 470, damage: 50, range: 110, speed: 3000, color: '#D2B48C', icon: '„Ä∞Ô∏è' },
            roadBlock: { name: '–ë–ª–æ–∫–∞–¥–∞', cost: 360, damage: 30, range: 0, speed: 2500, color: '#CD853F', icon: 'üõë' },
            summon: { name: '–ü—Ä–∏–∑—ã–≤–∞—Ç–µ–ª—å', cost: 550, damage: 0, range: 130, speed: 6000, color: '#FFA07A', icon: 'üêæ' },
            blind: { name: '–û—Å–ª–µ–ø–∏—Ç–µ–ª—å', cost: 410, damage: 0, range: 150, speed: 3500, color: '#FAFAD2', icon: 'üîÜ' },
            sacrificial: { name: '–ñ–µ—Ä—Ç–≤–µ–Ω–Ω—ã–π', cost: 370, damage: 5, range: 160, speed: 1000, color: '#C71585', icon: 'ü©∏' },
            debuffer: { name: '–î–µ–±–∞—Ñ—Ñ–µ—Ä', cost: 230, damage: 10, range: 140, speed: 1500, color: '#008B8B', icon: 'üîª' },
            ultimate: { name: '–£–ª—å—Ç–∏–º–∞—Ç—É–º', cost: 1000, damage: 200, range: 200, speed: 10000, color: '#FFD700', icon: 'üëë' } 
        };
        
        // –¢–∏–ø—ã –≤—Ä–∞–≥–æ–≤ (60 –≤–∏–¥–æ–≤)
        const enemyTypes = [
            // –ë–∞–∑–æ–≤—ã–µ 40 –≤—Ä–∞–≥–æ–≤
            { name: 'üëπ –ì–æ–±–ª–∏–Ω', health: 100, speed: 1.2, color: '#70e000', money: 20 },
            { name: 'üßå –û—Ä–∫', health: 200, speed: 0.8, color: '#ff4800', money: 40 },
            { name: 'üíÄ –°–∫–µ–ª–µ—Ç', health: 150, speed: 1.0, color: '#f8f9fa', money: 30 },
            { name: 'üëª –ü—Ä–∏–∑—Ä–∞–∫', health: 120, speed: 1.4, color: '#c77dff', money: 35 },
            { name: 'ü¶Ö –ì–∞—Ä–ø–∏—è', health: 110, speed: 1.5, color: '#ff85a2', money: 45 },
            { name: 'üßü‚Äç‚ôÇÔ∏è –ó–æ–º–±–∏', health: 250, speed: 0.6, color: '#6a040f', money: 50 },
            { name: 'ü§ñ –†–æ–±–æ—Ç', health: 300, speed: 0.7, color: '#696969', money: 60 },
            { name: 'üëΩ –ò–Ω–æ–ø–ª–∞–Ω–µ—Ç—è–Ω–∏–Ω', health: 140, speed: 1.3, color: '#32cd32', money: 55 },
            { name: 'üßô‚Äç‚ôÄÔ∏è –ö–æ–ª–¥—É–Ω—å—è', health: 180, speed: 1.0, color: '#9370db', money: 65 },
            { name: 'üï∑Ô∏è –ü–∞—É–∫', health: 160, speed: 1.6, color: '#000000', money: 40 },
            { name: 'üßä –õ–µ–¥—è–Ω–æ–π –ì–æ–ª–µ–º', health: 400, speed: 0.5, color: '#38b000', money: 80 },
            { name: 'üî• –î–µ–º–æ–Ω', health: 320, speed: 0.9, color: '#ff0000', money: 75 },
            { name: 'üêô –ö—Ä–∞–∫–µ–Ω', health: 350, speed: 0.7, color: '#2e8b57', money: 85 },
            { name: 'üëÅÔ∏è –¶–∏–∫–ª–æ–ø', health: 280, speed: 0.8, color: '#ff4500', money: 70 },
            { name: 'üßõ –í–∞–º–ø–∏—Ä', health: 240, speed: 1.1, color: '#8b0000', money: 65 },
            { name: 'üó°Ô∏è –†—ã—Ü–∞—Ä—å', health: 260, speed: 0.9, color: '#3a0ca3', money: 75 },
            { name: '‚öîÔ∏è –°–∞–º—É—Ä–∞–π', health: 220, speed: 1.3, color: '#000080', money: 70 },
            { name: 'üß™ –ê–ª—Ö–∏–º–∏–∫', health: 190, speed: 1.0, color: '#f72585', money: 80 },
            { name: 'ü¶ñ –î–∏–Ω–æ–∑–∞–≤—Ä', health: 380, speed: 0.8, color: '#e63946', money: 90 },
            { name: 'üê≤ –î–†–ê–ö–û–ù', health: 500, speed: 0.5, color: '#ff0000', money: 200 },
            { name: 'üí® –í–æ–∑–¥—É—à–Ω—ã–π –®–∞—Ä', health: 100, speed: 2.0, color: '#ADD8E6', money: 45 },
            { name: 'üß± –ö–∞–º–µ–Ω–Ω—ã–π –°—Ç—Ä–∞–∂', health: 600, speed: 0.4, color: '#BDB76B', money: 120 },
            { name: 'üí° –ù–µ–∫—Å—É—Å', health: 150, speed: 1.1, color: '#F0E68C', money: 50 },
            { name: 'üê∏ –õ—è–≥—É—à–∫–∞', health: 130, speed: 0.9, color: '#228B22', money: 30 },
            { name: 'üõ°Ô∏è –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π', health: 350, speed: 0.7, color: '#C0C0C0', money: 70 },
            { name: 'üî™ –£–±–∏–π—Ü–∞', health: 180, speed: 1.8, color: '#101010', money: 60 },
            { name: 'üî• –§–µ–Ω–∏–∫—Å', health: 250, speed: 1.5, color: '#FF7F50', money: 80 },
            { name: 'üí£ –°–∞–º–æ—É–±–∏–π—Ü–∞', health: 100, speed: 1.3, color: '#B22222', money: 20 },
            { name: 'üí∏ –ú–∞—Ä–æ–¥–µ—Ä', health: 200, speed: 1.0, color: '#DAA520', money: 150 },
            { name: 'üåÄ –ò–ª–ª—é–∑–∏—è', health: 50, speed: 1.2, color: '#DDA0DD', money: 25 },
            { name: 'üêç –ú–µ–¥—É–∑–∞', health: 210, speed: 0.8, color: '#800080', money: 65 },
            { name: '‚ö° –≠–ª–µ–∫—Ç—Ä–∏–∫', health: 170, speed: 1.4, color: '#FFFF00', money: 70 },
            { name: 'üåä –í–æ–¥—è–Ω–æ–π', health: 230, speed: 1.0, color: '#4169E1', money: 75 },
            { name: 'ü™µ –õ–µ—Å–æ—Ä—É–±', health: 270, speed: 0.6, color: '#8B4513', money: 85 },
            { name: '‚öôÔ∏è –ú–µ—Ö–∞–Ω–∏–∑–º', health: 450, speed: 0.5, color: '#A9A9A9', money: 100 },
            { name: 'üçÑ –ì—Ä–∏–±', health: 160, speed: 1.1, color: '#808000', money: 50 },
            { name: 'üåà –°–ø–µ–∫—Ç—Ä', health: 10, speed: 1.7, color: '#FF1493', money: 25 },
            { name: 'üåô –¢–µ–Ω–µ–≤–æ–π –í–æ–ª–∫', health: 190, speed: 1.6, color: '#191970', money: 70 },
            { name: 'üåå –ê–Ω–æ–º–∞–ª–∏—è', health: 300, speed: 1.3, color: '#4B0082', money: 95 },
            { name: 'üëë –í–ï–†–•–û–í–ù–´–ô –î–†–ê–ö–û–ù', health: 1000, speed: 0.3, color: '#000000', money: 500 },
            // –ù–æ–≤—ã–µ 20 –≤—Ä–∞–≥–æ–≤ (41-60)
            { name: 'ü¶ü –†–æ–π –ú–æ—Å–∫–∏—Ç–æ–≤', health: 80, speed: 2.5, color: '#6B8E23', money: 30 }, 
            { name: 'üíé –ö—Ä–∏—Å—Ç–∞–ª–ª', health: 400, speed: 0.5, color: '#00CED1', money: 150 }, 
            { name: 'üöß –ò–Ω–∂–µ–Ω–µ—Ä', health: 220, speed: 0.7, color: '#B0C4DE', money: 60 }, 
            { name: 'ü¶† –ú—É—Ç–∞–Ω—Ç', health: 350, speed: 1.0, color: '#DAA520', money: 80 }, 
            { name: 'ü™∂ –ü—Ä–∏–∑—Ä–∞–∫ –ü–µ—Ä–∞', health: 130, speed: 1.8, color: '#FFE4B5', money: 55 }, 
            { name: '‚öôÔ∏è –ß–∞—Å–æ–≤–æ–π –ú–µ—Ö–∞–Ω–∏–∑–º', health: 480, speed: 0.6, color: '#778899', money: 110 }, 
            { name: 'üå™Ô∏è –≠–ª–µ–º–µ–Ω—Ç–∞–ª—å –í–µ—Ç—Ä–∞', health: 200, speed: 2.2, color: '#E0FFFF', money: 75 }, 
            { name: 'üî• –û–±–≥–æ—Ä–µ–≤—à–∏–π', health: 300, speed: 0.9, color: '#800000', money: 90 }, 
            { name: 'üê¢ –ß–µ—Ä–µ–ø–∞—Ö–∞', health: 550, speed: 0.2, color: '#2F4F4F', money: 130 }, 
            { name: 'üì° –†–µ–∑–æ–Ω–∞—Ç–æ—Ä', health: 260, speed: 1.1, color: '#8B008B', money: 85 }, 
            { name: 'üöÄ –†–∞–∫–µ—Ç–∞', health: 150, speed: 3.0, color: '#B22222', money: 70 }, 
            { name: 'üß™ –•–∏–º–∏–∫', health: 240, speed: 1.0, color: '#6A5ACD', money: 80 }, 
            { name: 'üå≤ –≠–Ω—Ç', health: 420, speed: 0.6, color: '#556B2F', money: 95 }, 
            { name: 'üåë –¢–µ–Ω—å', health: 190, speed: 1.4, color: '#2F4F4F', money: 65 }, 
            { name: 'üí• –Ø–¥—Ä–æ', health: 330, speed: 0.8, color: '#FFA500', money: 100 }, 
            { name: 'ü™± –ß–µ—Ä–≤—å', health: 210, speed: 0.7, color: '#CD853F', money: 75 }, 
            { name: 'üÉè –î–∂–æ–∫–µ—Ä', health: 10, speed: 1.5, color: '#FF4500', money: 50 }, 
            { name: 'üï∞Ô∏è –•—Ä–∞–Ω–∏—Ç–µ–ª—å –í—Ä–µ–º–µ–Ω–∏', health: 280, speed: 1.0, color: '#00BFFF', money: 90 }, 
            { name: 'üåå –ö–æ—Å–º–æ–Ω–∞–≤—Ç', health: 370, speed: 1.2, color: '#483D8B', money: 120 }, 
            { name: 'üëë –¢–ò–¢–ê–ù', health: 2000, speed: 0.1, color: '#FFD700', money: 1000 } 
        ];
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        function initGame() {
            // –°–æ–∑–¥–∞–µ–º —É—Ä–æ–≤–Ω–∏
            createLevels();
            
            // –°–æ–∑–¥–∞–µ–º –±–∞—à–Ω–∏ –≤ –ø–∞–Ω–µ–ª–∏
            createTowerButtons();
            
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            setupEventListeners();
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π
        function createLevels() {
            levelsGrid.innerHTML = '';
            // –°–æ–∑–¥–∞–µ–º 20 –∫–Ω–æ–ø–æ–∫ –¥–ª—è —É—Ä–æ–≤–Ω–µ–π
            for (let i = 1; i <= 20; i++) {
                const levelBtn = document.createElement('div');
                levelBtn.className = 'level-btn';
                if (game.completedLevels.includes(i)) {
                    levelBtn.classList.add('completed');
                } else if (i > 1 && !game.completedLevels.includes(i - 1)) {
                    levelBtn.classList.add('locked');
                }
                
                levelBtn.innerHTML = `
                    <div>${i}</div>
                    <div class="level-name">${levels[i-1].name}</div>
                `;
                
                levelBtn.addEventListener('click', () => {
                    if (!levelBtn.classList.contains('locked')) {
                        startLevel(i);
                    }
                });
                
                levelsGrid.appendChild(levelBtn);
            }
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –±–∞—à–µ–Ω
        function createTowerButtons() {
            towerList.innerHTML = '';
            Object.entries(towerTypes).forEach(([id, tower]) => {
                const towerItem = document.createElement('div');
                towerItem.className = 'tower-item';
                towerItem.dataset.tower = id;
                towerItem.title = `${tower.name} (–£—Ä–æ–Ω: ${tower.damage}, –°–∫–æ—Ä–æ—Å—Ç—å: ${tower.speed}ms, –î–∞–ª—å–Ω–æ—Å—Ç—å: ${tower.range})`; // –ü–æ–¥—Å–∫–∞–∑–∫–∞
                
                towerItem.innerHTML = `
                    <div class="tower-icon">${tower.icon}</div>
                    <div class="tower-name">${tower.name}</div>
                    <div class="tower-cost">${tower.cost}üí∞</div>
                `;
                
                towerItem.addEventListener('click', () => {
                    document.querySelectorAll('.tower-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    towerItem.classList.add('selected');
                    game.selectedTower = id;
                });
                
                towerList.appendChild(towerItem);
            });
            
            // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é –±–∞—à–Ω—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            if (towerList.children.length > 0) {
                 towerList.children[0].classList.add('selected');
            }
        }
        
        // –ù–∞—á–∞–ª–æ —É—Ä–æ–≤–Ω—è
        function startLevel(level) {
            game.currentLevel = level;
            game.currentWave = 0;
            game.health = levels[level-1].health;
            game.money = levels[level-1].money;
            game.score = 0;
            game.kills = 0;
            game.towers = [];
            game.enemies = [];
            game.projectiles = [];
            game.effects = [];
            game.selectedTowerIndex = -1;
            game.waveInProgress = false;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById('currentLevel').textContent = level;
            document.getElementById('currentWave').textContent = `0/${game.maxWaves}`;
            document.getElementById('health').textContent = game.health;
            document.getElementById('money').textContent = game.money;
            document.getElementById('score').textContent = game.score;
            
            // –°–æ–∑–¥–∞–µ–º –ø—É—Ç—å –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
            createPathForLevel(level);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–≥—Ä–æ–≤–æ–π —ç–∫—Ä–∞–Ω
            levelSelectScreen.classList.add('hidden');
            gameScreen.classList.add('active');
            game.gameRunning = true;
            game.gamePaused = false;
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
            gameLoop();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –ø–µ—Ä–≤–æ–π –≤–æ–ª–Ω—ã
            showWaveScreen();
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –ø—É—Ç–∏ –¥–ª—è —É—Ä–æ–≤–Ω—è (—Ç–∞ –∂–µ –ª–æ–≥–∏–∫–∞, —á—Ç–æ –∏ —Ä–∞–Ω–µ–µ)
        function createPathForLevel(level) {
            game.path = [];
            
            switch(level % 4) {
                case 1:
                    game.path = [
                        {x: -50, y: 300}, {x: 200, y: 300}, {x: 200, y: 200}, {x: 400, y: 200},
                        {x: 400, y: 400}, {x: 600, y: 400}, {x: 600, y: 300}, {x: 850, y: 300}
                    ];
                    break;
                case 2:
                    game.path = [
                        {x: -50, y: 150}, {x: 150, y: 150}, {x: 150, y: 450}, {x: 350, y: 450},
                        {x: 350, y: 100}, {x: 550, y: 100}, {x: 550, y: 500}, {x: 750, y: 500},
                        {x: 750, y: 200}, {x: 850, y: 200}
                    ];
                    break;
                case 3:
                    game.path = [
                        {x: -50, y: 100}, {x: 100, y: 100}, {x: 100, y: 500}, {x: 250, y: 500},
                        {x: 250, y: 150}, {x: 400, y: 150}, {x: 400, y: 450}, {x: 550, y: 450},
                        {x: 550, y: 200}, {x: 700, y: 200}, {x: 700, y: 400}, {x: 850, y: 400}
                    ];
                    break;
                default:
                    game.path = [
                        {x: -50, y: 300}, {x: 150, y: 300}, {x: 150, y: 150}, {x: 300, y: 150},
                        {x: 300, y: 300}, {x: 450, y: 300}, {x: 450, y: 450}, {x: 600, y: 450},
                        {x: 600, y: 300}, {x: 750, y: 300}, {x: 850, y: 300}
                    ];
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –≤–æ–ª–Ω—ã
        function showWaveScreen() {
            waveScreen.classList.add('active');
            const waveTitle = document.getElementById('waveTitle');
            const waveEnemies = document.getElementById('waveEnemies');
            
            if (game.currentWave === 0) {
                waveTitle.textContent = `–£–†–û–í–ï–ù–¨ ${game.currentLevel}`;
                waveEnemies.textContent = levels[game.currentLevel-1].name;
            } else {
                waveTitle.textContent = `–í–û–õ–ù–ê ${game.currentWave}`;
                
                const enemiesInfo = [];
                if (game.currentWave % 5 === 0) {
                    enemiesInfo.push('–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –±–æ—Å—Å!');
                } else {
                    enemiesInfo.push(`${5 + Math.floor(game.currentWave/2)} –≤—Ä–∞–≥–æ–≤`);
                }
                
                waveEnemies.textContent = enemiesInfo.join(' ‚Ä¢ ');
            }
            
            game.waveStartTime = Date.now();
        }
        
        // –ù–∞—á–∞—Ç—å –≤–æ–ª–Ω—É
        function startWave() {
            waveScreen.classList.remove('active');
            game.currentWave++;
            document.getElementById('currentWave').textContent = `${game.currentWave}/${game.maxWaves}`;
            
            game.waveInProgress = true;
            game.enemyCount = 0;
            
            if (game.currentWave % 5 === 0) {
                game.maxEnemies = 1;
            } else {
                game.maxEnemies = 5 + Math.floor(game.currentWave / 2);
            }
            
            spawnEnemies();
        }
        
        // –°–ø–∞–≤–Ω –≤—Ä–∞–≥–æ–≤
        function spawnEnemies() {
            if (game.enemyCount >= game.maxEnemies || !game.gameRunning) return;
            
            let enemyTypeIndex;
            if (game.currentWave % 5 === 0) {
                // –ë–æ—Å—Å: –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ —Å–∏–ª—å–Ω—ã—Ö –≤—Ä–∞–≥–æ–≤, –±–ª–∏–∂–µ –∫ –∫–æ–Ω—Ü—É —Å–ø–∏—Å–∫–∞
                enemyTypeIndex = Math.min(
                    39 + Math.floor(game.currentWave / 2), 
                    enemyTypes.length - 1
                ); 
            } else {
                // –û–±—ã—á–Ω—ã–µ –≤—Ä–∞–≥–∏: —Å–∏–ª–∞ —Ä–∞—Å—Ç–µ—Ç —Å –≤–æ–ª–Ω–æ–π
                enemyTypeIndex = Math.min(
                    Math.floor(game.currentWave / 2) + Math.floor(Math.random() * 5),
                    enemyTypes.length - 3
                );
            }
            
            const enemyType = enemyTypes[enemyTypeIndex];
            const level = levels[game.currentLevel-1];
            
            const enemy = {
                x: game.path[0].x,
                y: game.path[0].y,
                pathIndex: 0,
                health: enemyType.health * (level.enemyHealth / 100) * (1 + (game.currentWave - 1) * 0.1),
                maxHealth: enemyType.health * (level.enemyHealth / 100) * (1 + (game.currentWave - 1) * 0.1),
                speed: enemyType.speed * level.enemySpeed,
                color: enemyType.color,
                money: enemyType.money + game.currentWave * 2,
                name: enemyType.name,
                boss: game.currentWave % 5 === 0,
                typeIndex: enemyTypeIndex,
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–≤–æ–π—Å—Ç–≤–∞ –¥–ª—è –Ω–æ–≤—ã—Ö –≤—Ä–∞–≥–æ–≤
                isInvulnerable: false,
                isStunned: false,
                isSlowed: false, // –î–æ–±–∞–≤–ª–µ–Ω–æ
            };
            
            game.enemies.push(enemy);
            game.enemyCount++;
            
            const spawnDelay = enemy.boss ? 3000 : (1000 + Math.random() * 1000);
            setTimeout(spawnEnemies, spawnDelay);
        }
        
        // –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
        function gameLoop() {
            if (!game.gameRunning || game.gamePaused) {
                requestAnimationFrame(gameLoop);
                return;
            }
            
            updateGame();
            drawGame();
            checkGameState();
            
            requestAnimationFrame(gameLoop);
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–≤–æ–π –ª–æ–≥–∏–∫–∏
        function updateGame() {
            updateEnemies();
            updateTowers();
            updateProjectiles();
            updateEffects();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏–µ –≤–æ–ª–Ω—ã
            if (game.waveInProgress && game.enemies.length === 0 && game.enemyCount >= game.maxEnemies) {
                game.waveInProgress = false;
                
                const waveReward = 50 + game.currentWave * 10;
                game.money += waveReward;
                game.score += waveReward * 10;
                updateUI();
                
                if (game.currentWave >= game.maxWaves) {
                    victory();
                } else {
                    setTimeout(() => showWaveScreen(), 1000);
                }
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–∞–≥–æ–≤
        function updateEnemies() {
            for (let i = game.enemies.length - 1; i >= 0; i--) {
                const enemy = game.enemies[i];
                
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ, –µ—Å–ª–∏ –≤—Ä–∞–≥ –æ–≥–ª—É—à–µ–Ω
                if (enemy.isStunned) continue;

                // –î–≤–∏–∂–µ–Ω–∏–µ –ø–æ –ø—É—Ç–∏
                const target = game.path[enemy.pathIndex + 1];
                if (target) {
                    const dx = target.x - enemy.x;
                    const dy = target.y - enemy.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < enemy.speed) {
                        enemy.pathIndex++;
                    } else {
                        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–∫—É—â—É—é —Å–∫–æ—Ä–æ—Å—Ç—å
                        enemy.x += (dx / distance) * enemy.speed;
                        enemy.y += (dy / distance) * enemy.speed;
                    }
                } else {
                    // –í—Ä–∞–≥ –¥–æ—Å—Ç–∏–≥ –±–∞–∑—ã
                    game.health -= enemy.boss ? 20 : 10;
                    game.enemies.splice(i, 1);
                    
                    if (game.health <= 0) {
                        game.health = 0;
                        defeat();
                    }
                    updateUI();
                    continue;
                }
                
                // –°–º–µ—Ä—Ç—å –≤—Ä–∞–≥–∞
                if (enemy.health <= 0) {
                    game.money += enemy.money;
                    game.score += enemy.money * 5;
                    game.kills++;
                    
                    // –õ–æ–≥–∏–∫–∞ –¥–ª—è –≤—Ä–∞–≥–∞ –ú—É—Ç–∞–Ω—Ç–∞ (–¥–µ–ª–∏—Ç—Å—è –Ω–∞ 2)
                    if (enemy.name.includes('–ú—É—Ç–∞–Ω—Ç') && !enemy.split) {
                         for (let j = 0; j < 2; j++) {
                            game.enemies.push({
                                x: enemy.x + (j * 10 - 5), // –ù–µ–º–Ω–æ–≥–æ —Å–º–µ—â–∞–µ–º
                                y: enemy.y,
                                pathIndex: enemy.pathIndex,
                                health: enemy.maxHealth / 2,
                                maxHealth: enemy.maxHealth / 2,
                                speed: enemy.speed * 1.5,
                                color: '#A52A2A',
                                money: enemy.money / 2,
                                name: '–ú–µ–ª–∫–∏–π –ú—É—Ç–∞–Ω—Ç',
                                boss: false,
                                split: true, // –§–ª–∞–≥, —á—Ç–æ–±—ã –Ω–µ –¥–µ–ª–∏–ª—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ
                                isInvulnerable: false,
                                isStunned: false,
                                isSlowed: false
                            });
                        }
                    }

                    game.enemies.splice(i, 1);
                    updateUI();
                    
                    if (enemy.boss) {
                        createExplosion(enemy.x, enemy.y, 50);
                    }
                }
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞—à–µ–Ω
        function updateTowers() {
            const now = Date.now();
            
            game.towers.forEach((tower, index) => {
                const type = towerTypes[tower.type];
                if (!type) return;
                
                // –ù–∞—Ö–æ–¥–∏–º —Ü–µ–ª—å (–±–ª–∏–∂–∞–π—à–∏–π –≤—Ä–∞–≥ –≤ —Ä–∞–¥–∏—É—Å–µ)
                let target = null;
                let minDistance = tower.range;
                
                game.enemies.forEach(enemy => {
                    const dx = enemy.x - tower.x;
                    const dy = enemy.y - tower.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < minDistance) {
                        minDistance = distance;
                        target = enemy;
                    }
                });
                
                // –û—Å–æ–±–∞—è –ª–æ–≥–∏–∫–∞ –±–∞—à–µ–Ω
                if (target && now - tower.lastShot > tower.speed) {
                    tower.lastShot = now;
                    
                    let damage = tower.damage;

                    switch(tower.type) {
                        case 'sonic':
                            game.projectiles.push({ x: tower.x, y: tower.y, target: target, damage: damage, color: type.color, speed: 15 });
                            break;
                            
                        case 'mario':
                            if (!tower.jumping) {
                                tower.jumping = true;
                                tower.jumpTarget = target;
                                tower.jumpStart = now;
                                
                                setTimeout(() => {
                                    game.enemies.forEach(e => {
                                        const dist = Math.sqrt(Math.pow(e.x - target.x, 2) + Math.pow(e.y - target.y, 2));
                                        if (dist < 60) e.health -= damage * 0.7; 
                                    });
                                    tower.jumping = false;
                                }, 500);
                            }
                            break;
                            
                        case 'teleporter':
                            const pathLength = game.path.length;
                            const currentPathIndex = target.pathIndex;
                            const pathNodesToMoveBack = Math.max(1, Math.floor(pathLength * 0.1)); 
                            const newPathIndex = Math.max(0, currentPathIndex - pathNodesToMoveBack);
                            
                            const targetIndex = Math.min(newPathIndex, pathLength - 2); 
                            const newPos = game.path[targetIndex];
                            
                            target.pathIndex = targetIndex;
                            target.x = newPos.x;
                            target.y = newPos.y;
                            target.health -= damage; 
                            break;
                            
                        case 'spearman':
                            game.projectiles.push({ x: tower.x, y: tower.y, target: target, damage: damage, color: type.color, speed: 10 });
                            break;
                            
                        case 'tesla':
                            // –¶–µ–ø–Ω–∞—è –º–æ–ª–Ω–∏—è (3 —Ü–µ–ª–∏)
                            const targets = [target];
                            // ... (–ª–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞ –¥–≤—É—Ö –±–ª–∏–∂–∞–π—à–∏—Ö —Ü–µ–ª–µ–π)
                            for (let i = 0; i < 2; i++) {
                                let closest = null;
                                let minDist = 100;
                                game.enemies.forEach(e => {
                                    if (!targets.includes(e)) {
                                        const dist = Math.sqrt(Math.pow(e.x - targets[targets.length - 1].x, 2) + Math.pow(e.y - targets[targets.length - 1].y, 2));
                                        if (dist < minDist) { minDist = dist; closest = e; }
                                    }
                                });
                                if (closest) targets.push(closest);
                            }
                            targets.forEach(t => { t.health -= damage * (t === target ? 1 : 0.7); });
                            break;
                        
                        case 'percent':
                            // –£—Ä–æ–Ω, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ 5% –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è
                            damage += target.health * 0.05;
                            game.projectiles.push({ x: tower.x, y: tower.y, target: target, damage: damage, color: type.color, speed: 8 });
                            break;

                        case 'freezer':
                            // –ì–ª—É–±–æ–∫–∞—è –∑–∞–º–æ—Ä–æ–∑–∫–∞ (—Å—Ç–∞–Ω)
                            target.isStunned = true;
                            setTimeout(() => { target.isStunned = false; }, 3000); // 3 —Å–µ–∫—É–Ω–¥—ã —Å—Ç–∞–Ω–∞
                            game.projectiles.push({ x: tower.x, y: tower.y, target: target, damage: damage, color: type.color, speed: 8 });
                            break;
                        
                        case 'execute':
                            // –£—Ä–æ–Ω —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è, –µ—Å–ª–∏ –∑–¥–æ—Ä–æ–≤—å–µ —Ü–µ–ª–∏ –Ω–∏–∑–∫–æ–µ (–º–µ–Ω–µ–µ 30%)
                            if (target.health / target.maxHealth < 0.3) {
                                damage *= 2; 
                            }
                            game.projectiles.push({ x: tower.x, y: tower.y, target: target, damage: damage, color: type.color, speed: 8 });
                            break;
                        
                        case 'buff':
                             // –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç—Ä–µ–ª—å–Ω–æ—Å—Ç—å —Å–æ—Å–µ–¥–Ω–∏—Ö –±–∞—à–µ–Ω
                            game.towers.forEach(t => {
                                const dist = Math.sqrt(Math.pow(t.x - tower.x, 2) + Math.pow(t.y - tower.y, 2));
                                if (dist < 100 && t !== tower) {
                                    if (!t.isBuffed) {
                                        t.speed *= 0.8; // –£—Å–∫–æ—Ä—è–µ–º –Ω–∞ 20%
                                        t.isBuffed = true;
                                        setTimeout(() => { 
                                            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å, –ø—Ä–æ–≤–µ—Ä—è—è, —á—Ç–æ –±–∞—à–Ω—è –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                                            if (t) {
                                                t.speed /= 0.8; 
                                                t.isBuffed = false;
                                            }
                                        }, 5000); // –ë–∞—Ñ—Ñ –Ω–∞ 5 —Å–µ–∫—É–Ω–¥
                                    }
                                }
                            });
                            // –ë–∞—à–Ω—è –Ω–∏—á–µ–≥–æ –Ω–µ —Å—Ç—Ä–µ–ª—è–µ—Ç, –ø—Ä–æ—Å—Ç–æ –±–∞—Ñ—Ñ–∞–µ—Ç
                            break; 
                            
                        case 'sacrificial':
                            // –£—Ä–æ–Ω –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –∑–¥–æ—Ä–æ–≤—å—è –±–∞–∑—ã
                            damage += (100 - game.health) * 0.5;
                            game.projectiles.push({ x: tower.x, y: tower.y, target: target, damage: damage, color: type.color, speed: 8 });
                            break;

                        default:
                            // –û–±—ã—á–Ω–∞—è –∞—Ç–∞–∫–∞ –¥–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
                            game.projectiles.push({ x: tower.x, y: tower.y, target: target, damage: damage, color: type.color, speed: 8 });
                    }
                }
            });
            
            // –õ–æ–≥–∏–∫–∞ –ø–∞—Å—Å–∏–≤–Ω—ã—Ö/–ê–æ–ï –±–∞—à–µ–Ω
            game.towers.forEach(tower => {
                 if (tower.type === 'slowField') {
                    game.enemies.forEach(enemy => {
                         const dist = Math.sqrt(Math.pow(enemy.x - tower.x, 2) + Math.pow(enemy.y - tower.y, 2));
                         if (dist < tower.range) {
                             // –í—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–º–µ–¥–ª—è–µ–º
                            if (!enemy.isSlowed) {
                                enemy.originalSpeed = enemy.speed; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å
                                enemy.speed *= 0.5; // –ó–∞–º–µ–¥–ª—è–µ–º –Ω–∞ 50%
                                enemy.isSlowed = true;
                            }
                         } else if (enemy.isSlowed) {
                             // –ï—Å–ª–∏ –≤—ã—à–µ–ª –∏–∑ –∑–æ–Ω—ã, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å
                            enemy.speed = enemy.originalSpeed;
                            enemy.isSlowed = false;
                            delete enemy.originalSpeed;
                         }
                    });
                 }
            });
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–Ω–∞—Ä—è–¥–æ–≤
        function updateProjectiles() {
            for (let i = game.projectiles.length - 1; i >= 0; i--) {
                const proj = game.projectiles[i];
                
                if (!proj.target || proj.target.health <= 0) {
                    game.projectiles.splice(i, 1);
                    continue;
                }
                
                const dx = proj.target.x - proj.x;
                const dy = proj.target.y - proj.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < proj.speed) {
                    proj.target.health -= proj.damage;
                    game.projectiles.splice(i, 1);
                } else {
                    proj.x += (dx / distance) * proj.speed;
                    proj.y += (dy / distance) * proj.speed;
                }
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        function updateEffects() {
            for (let i = game.effects.length - 1; i >= 0; i--) {
                const effect = game.effects[i];
                if (Date.now() > effect.endTime) {
                    game.effects.splice(i, 1);
                }
            }
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –≤–∑—Ä—ã–≤–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        function createExplosion(x, y, radius) {
            game.effects.push({
                x: x,
                y: y,
                radius: radius,
                startTime: Date.now(),
                endTime: Date.now() + 500
            });
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–≥—Ä—ã
        function drawGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            drawBackground();
            drawPath();
            drawTowers();
            drawEnemies();
            drawProjectiles();
            drawEffects();
            
            if (!game.waveInProgress && game.selectedTower) {
                drawSelectedTower();
            }
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤—Ä–∞–≥–æ–≤ (–¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞–Ω–∞)
        function drawEnemies() {
            game.enemies.forEach(enemy => {
                const size = enemy.boss ? 25 : 15;
                
                // –†–∏—Å—É–µ–º –≤—Ä–∞–≥–∞
                ctx.fillStyle = enemy.color;
                ctx.beginPath();
                ctx.arc(enemy.x, enemy.y, size, 0, Math.PI * 2);
                ctx.fill();

                // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞–Ω–∞
                if (enemy.isStunned) {
                    ctx.fillStyle = '#FFEB3B';
                    ctx.font = '20px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('‚≠ê', enemy.x, enemy.y - size - 15);
                }
                
                // –ü–æ–ª–æ—Å–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
                const healthWidth = 40;
                const healthPercent = enemy.health / enemy.maxHealth;
                
                ctx.fillStyle = '#333';
                ctx.fillRect(enemy.x - healthWidth/2, enemy.y - size - 10, healthWidth, 5);
                
                ctx.fillStyle = healthPercent > 0.5 ? '#4CAF50' : 
                              healthPercent > 0.25 ? '#FFC107' : '#F44336';
                ctx.fillRect(enemy.x - healthWidth/2, enemy.y - size - 10, healthWidth * healthPercent, 5);
                
                // –ò–º—è –≤—Ä–∞–≥–∞ (–¥–ª—è –±–æ—Å—Å–∞)
                if (enemy.boss) {
                    ctx.fillStyle = '#ffd700';
                    ctx.font = 'bold 12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('üëë', enemy.x, enemy.y - size - 15);
                }
            });
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –±–∞—à–µ–Ω (–¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è Slow Field)
        function drawTowers() {
            game.towers.forEach((tower, index) => {
                const type = towerTypes[tower.type];
                if (!type) return;
                
                // –†–∞–¥–∏—É—Å –∞—Ç–∞–∫–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ
                if (index === game.selectedTowerIndex) {
                    ctx.beginPath();
                    ctx.arc(tower.x, tower.y, tower.range, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(0, 255, 136, 0.1)';
                    ctx.fill();
                    ctx.strokeStyle = '#00ff88';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }

                // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è Slow Field
                if (tower.type === 'slowField') {
                    ctx.beginPath();
                    ctx.arc(tower.x, tower.y, tower.range, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(70, 130, 180, 0.15)'; 
                    ctx.fill();
                }
                
                // –†–∏—Å—É–µ–º –±–∞—à–Ω—é
                ctx.fillStyle = type.color;
                ctx.beginPath();
                ctx.arc(tower.x, tower.y, 20, 0, Math.PI * 2);
                ctx.fill();
                
                // –£—Ä–æ–≤–µ–Ω—å –±–∞—à–Ω–∏
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(tower.level, tower.x, tower.y + 4);
                
                // –û—Å–æ–±—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –ú–∞—Ä–∏–æ (–ø—Ä—ã–∂–æ–∫)
                if (tower.type === 'mario' && tower.jumping) {
                    const progress = (Date.now() - tower.jumpStart) / 500;
                    const height = 50 * Math.sin(progress * Math.PI);
                    
                    ctx.fillStyle = '#E91E63';
                    ctx.beginPath();
                    ctx.arc(tower.x, tower.y - height, 25, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#fff';
                    ctx.font = '25px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('üë®‚Äçüîß', tower.x, tower.y - height + 9);
                } else {
                    ctx.fillStyle = '#fff';
                    ctx.font = '20px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(type.icon, tower.x, tower.y + 7);
                }
            });
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (drawBackground, drawPath, drawProjectiles, drawEffects, drawSelectedTower, checkGameState, victory, defeat, updateUI) - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        function drawBackground() {
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#0a1931');
            gradient.addColorStop(1, '#185adb');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 1;
            for (let x = 0; x < canvas.width; x += 50) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke(); }
            for (let y = 0; y < canvas.height; y += 50) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke(); }
        }
        
        function drawPath() {
            ctx.strokeStyle = '#8B4513';
            ctx.lineWidth = 40;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.beginPath();
            ctx.moveTo(game.path[0].x, game.path[0].y);
            for (let i = 1; i < game.path.length; i++) { ctx.lineTo(game.path[i].x, game.path[i].y); }
            ctx.stroke();
            ctx.strokeStyle = '#D2691E';
            ctx.lineWidth = 2;
            ctx.setLineDash([10, 5]);
            ctx.beginPath();
            ctx.moveTo(game.path[0].x, game.path[0].y);
            for (let i = 1; i < game.path.length; i++) { ctx.lineTo(game.path[i].x, game.path[i].y); }
            ctx.stroke();
            ctx.setLineDash([]);
            const end = game.path[game.path.length - 1];
            ctx.fillStyle = '#ff416c';
            ctx.beginPath();
            ctx.arc(end.x, end.y, 30, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('–ë–ê–ó–ê', end.x, end.y + 5);
        }
        
        function drawProjectiles() {
            game.projectiles.forEach(proj => {
                ctx.fillStyle = proj.color;
                ctx.beginPath();
                ctx.arc(proj.x, proj.y, 5, 0, Math.PI * 2);
                ctx.fill();
            });
        }
        
        function drawEffects() {
            game.effects.forEach(effect => {
                const progress = (Date.now() - effect.startTime) / (effect.endTime - effect.startTime);
                const radius = effect.radius * (1 - progress);
                const gradient = ctx.createRadialGradient( effect.x, effect.y, 0, effect.x, effect.y, radius );
                gradient.addColorStop(0, 'rgba(255, 140, 0, 0.8)');
                gradient.addColorStop(1, 'rgba(255, 69, 0, 0)');
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(effect.x, effect.y, radius, 0, Math.PI * 2);
                ctx.fill();
            });
        }
        
        function drawSelectedTower() {
            const type = towerTypes[game.selectedTower];
            if (!type || !game.mouseX || !game.mouseY || game.money < type.cost) return;
            ctx.beginPath();
            ctx.arc(game.mouseX, game.mouseY, type.range, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(0, 255, 136, 0.1)';
            ctx.fill();
            ctx.strokeStyle = '#00ff88';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.fillStyle = type.color;
            ctx.globalAlpha = 0.7;
            ctx.beginPath();
            ctx.arc(game.mouseX, game.mouseY, 20, 0, Math.PI * 2);
            ctx.fill();
            ctx.globalAlpha = 1;
            ctx.fillStyle = '#fff';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(type.icon, game.mouseX, game.mouseY + 7);
        }
        
        function checkGameState() {
            if (game.health <= 0) {
                defeat();
            }
        }
        
        function victory() {
            game.gameRunning = false;
            if (!game.completedLevels.includes(game.currentLevel)) {
                game.completedLevels.push(game.currentLevel);
                localStorage.setItem('tdCompletedLevels', JSON.stringify(game.completedLevels));
            }
            document.getElementById('victoryLevel').textContent = game.currentLevel;
            document.getElementById('victoryWaves').textContent = `${game.currentWave}/${game.maxWaves}`;
            document.getElementById('victoryKills').textContent = game.kills;
            document.getElementById('victoryGold').textContent = game.money;
            victoryScreen.classList.add('active');
        }
        
        function defeat() {
            game.gameRunning = false;
            document.getElementById('defeatLevel').textContent = game.currentLevel;
            document.getElementById('defeatWaves').textContent = `${game.currentWave}/${game.maxWaves}`;
            document.getElementById('defeatKills').textContent = game.kills;
            document.getElementById('defeatScore').textContent = game.score;
            defeatScreen.classList.add('active');
        }
        
        function updateUI() {
            document.getElementById('health').textContent = game.health;
            document.getElementById('money').textContent = game.money;
            document.getElementById('score').textContent = game.score;
            document.getElementById('currentWave').textContent = `${game.currentWave}/${game.maxWaves}`;
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        function setupEventListeners() {
            playBtn.addEventListener('click', () => { menuScreen.classList.add('hidden'); levelSelectScreen.classList.remove('hidden'); createLevels(); }); // –î–æ–±–∞–≤–∏–ª createLevels –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
            continueBtn.addEventListener('click', () => {
                if (game.completedLevels.length > 0) {
                    const lastLevel = Math.max(...game.completedLevels);
                    startLevel(lastLevel + 1 > 20 ? 20 : lastLevel + 1);
                } else {
                    startLevel(1);
                }
            });
            backToMenuBtn.addEventListener('click', () => { levelSelectScreen.classList.add('hidden'); menuScreen.classList.remove('hidden'); });
            
            document.getElementById('pauseBtn').addEventListener('click', () => {
                game.gamePaused = true;
                pauseScreen.classList.add('active');
                document.getElementById('levelProgress').textContent = 
                    `–£—Ä–æ–≤–µ–Ω—å ${game.currentLevel} ‚Ä¢ –í–æ–ª–Ω–∞ ${game.currentWave}/${game.maxWaves}`;
            });
            document.getElementById('menuBtn').addEventListener('click', () => {
                game.gameRunning = false;
                gameScreen.classList.remove('active');
                menuScreen.classList.remove('hidden');
                createLevels();
            });
            document.getElementById('resumeBtn').addEventListener('click', () => { game.gamePaused = false; pauseScreen.classList.remove('active'); });
            document.getElementById('restartLevelBtn').addEventListener('click', () => { pauseScreen.classList.remove('active'); startLevel(game.currentLevel); });
            document.getElementById('toMenuFromPauseBtn').addEventListener('click', () => { game.gameRunning = false; pauseScreen.classList.remove('active'); gameScreen.classList.remove('active'); menuScreen.classList.remove('hidden'); createLevels(); });
            document.getElementById('startWaveBtn').addEventListener('click', startWave);
            document.getElementById('nextLevelBtn').addEventListener('click', () => {
                victoryScreen.classList.remove('active');
                if (game.currentLevel < 20) { startLevel(game.currentLevel + 1); } else { gameScreen.classList.remove('active'); menuScreen.classList.remove('hidden'); createLevels(); }
            });
            document.getElementById('toMenuFromVictoryBtn').addEventListener('click', () => { victoryScreen.classList.remove('active'); gameScreen.classList.remove('active'); menuScreen.classList.remove('hidden'); createLevels(); });
            document.getElementById('restartFromDefeatBtn').addEventListener('click', () => { defeatScreen.classList.remove('active'); startLevel(game.currentLevel); });
            document.getElementById('toMenuFromDefeatBtn').addEventListener('click', () => { defeatScreen.classList.remove('active'); gameScreen.classList.remove('active'); menuScreen.classList.remove('hidden'); createLevels(); });
            
            document.getElementById('upgradeBtn').addEventListener('click', () => {
                if (game.selectedTowerIndex >= 0 && game.money >= 100) {
                    const tower = game.towers[game.selectedTowerIndex];
                    tower.damage *= 1.5; tower.range *= 1.2; tower.level++; game.money -= 100; updateUI();
                }
            });
            document.getElementById('sellBtn').addEventListener('click', () => {
                if (game.selectedTowerIndex >= 0) {
                    const tower = game.towers[game.selectedTowerIndex];
                    const refund = Math.floor(towerTypes[tower.type].cost * 0.5);
                    game.money += refund;
                    game.towers.splice(game.selectedTowerIndex, 1);
                    game.selectedTowerIndex = -1;
                    updateUI();
                }
            });
            
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                game.mouseX = e.clientX - rect.left;
                game.mouseY = e.clientY - rect.top;
            });
            
            canvas.addEventListener('click', (e) => {
                if (!game.gameRunning || game.gamePaused || game.waveInProgress) return;
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                for (let i = 0; i < game.towers.length; i++) {
                    const tower = game.towers[i];
                    const dx = x - tower.x;
                    const dy = y - tower.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    if (distance < 25) {
                        game.selectedTowerIndex = i;
                        document.querySelectorAll('.tower-item').forEach(item => { item.classList.remove('selected'); });
                        return;
                    }
                }
                
                game.selectedTowerIndex = -1; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –∫–ª–∏–∫ –Ω–µ –ø–æ –±–∞—à–Ω–µ
                
                const type = towerTypes[game.selectedTower];
                if (game.money >= type.cost) {
                    let valid = true;
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Ç–∏
                    for (const point of game.path) {
                        const dx = x - point.x;
                        const dy = y - point.y;
                        if (Math.sqrt(dx * dx + dy * dy) < 60) { valid = false; break; }
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏–º–∏ –±–∞—à–Ω—è–º–∏
                    for (const tower of game.towers) {
                        const dx = x - tower.x;
                        const dy = y - tower.y;
                        if (Math.sqrt(dx * dx + dy * dy) < 50) { valid = false; break; }
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü
                    if (x < 30 || x > canvas.width - 30 || y < 30 || y > canvas.height - 30) { valid = false; }
                    
                    if (valid) {
                        const tower = {
                            x: x, y: y, originalX: x, originalY: y, type: game.selectedTower,
                            damage: type.damage, range: type.range, speed: type.speed, color: type.color,
                            lastShot: 0, level: 1
                        };
                        game.towers.push(tower);
                        game.money -= type.cost;
                        game.selectedTowerIndex = game.towers.length - 1;
                        updateUI();
                    }
                }
            });
        }
        
        window.addEventListener('load', () => {
            initGame();
        });
    </script>
</body>
</html>
